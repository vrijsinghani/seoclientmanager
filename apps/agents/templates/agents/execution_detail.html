{% extends "agents/base_agents.html" %}
{% load static %}
{% load agent_tags %}  <!-- Add this line -->

{% block content %}
<div class="container-fluid py-4">
    <div class="card card-body blur shadow-blur mx-4 overflow-hidden">
        <div class="row gx-4">
            <div class="col-auto">
                <div class="avatar avatar-xxl position-relative">
                    {% if execution.crew.avatar %}
                        <img src="{% static 'assets/img/'|add:execution.crew.avatar %}" alt="{{ execution.crew.name }}" class="w-100 border-radius-lg shadow-sm">
                    {% else %}
                        <div class="avatar avatar-xxl bg-gradient-primary border-radius-lg shadow-sm">
                            <span class="text-white" style="font-size: 5.0rem;">{{ execution.crew.name|make_list|first|upper }}</span>
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-auto my-auto">
                <div class="h-100">
                    <h5 class="mb-1">{{ execution.crew.name }}</h5>
                    <p class="mb-0 font-weight-bold text-sm">
                        Status: <span class="badge bg-gradient-{{ status_class }}">{{ execution.get_status_display }}</span>
                    </p>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 my-sm-auto ms-sm-auto me-sm-0 mx-auto mt-3">
                <div class="nav-wrapper position-relative end-0">
                    <div class="avatar-group">
                        {% for agent in execution.crew.agents.all|slice:":8" %}
                            <a href="javascript:;" class="avatar avatar-lg rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="{{ agent.name }}">
                                <img src="{% static 'assets/img/'|add:agent.avatar %}" alt="{{ agent.name }}">
                            </a>
                        {% endfor %}
                        {% if execution.crew.agents.count > 8 %}
                            <a href="javascript:;" class="avatar avatar-lg rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="{{ execution.crew.agents.count|add:'-3' }} more">
                                <span class="avatar-text bg-gradient-primary">+{{ execution.crew.agents.count|add:'-8' }}</span>
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card h-100">
                <div class="card-header pb-0">
                    <h6>Execution Messages</h6>
                    <p class="text-sm">
                        <i class="fa fa-clock me-1"></i>
                        Last updated: {{ execution.updated_at|date:"SHORT_DATETIME_FORMAT" }}
                    </p>
                </div>
                <div class="card-body p-3">
                    <div class="messages-container" style="width: 100%; padding-left: 45px; position: relative;">
                        <!-- Timeline vertical line -->
                        <div style="position: absolute; left: 16px; top: 0; bottom: 0; width: 2px; background-color: #dee2e6;"></div>
                        
                        {% for message in messages %}
                        <div class="message-block" style="position: relative; margin-bottom: 1.5rem; width: 100%;">
                            <!-- Timeline step -->
                            <span style="position: absolute; left: -29px; width: 26px; height: 26px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; border: 2px solid #dee2e6;">
                                {% if message.agent %}
                                    <i class="ni ni-spaceship text-primary text-gradient"></i>
                                {% else %}
                                    <i class="ni ni-bell-55 text-success text-gradient"></i>
                                {% endif %}
                            </span>
                            
                            <!-- Message content -->
                            <div style="width: 100%;">
                                <div class="d-flex justify-content-between">
                                    <h6 class="text-dark text-sm font-weight-bold mb-0">
                                        {% if message.agent %}
                                            {{ message.agent }}
                                        {% else %}
                                            System Message
                                        {% endif %}
                                    </h6>
                                    <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">
                                        {{ message.timestamp|date:"d M H:i" }}
                                    </p>
                                </div>
                                <div class="message-content">
                                    <div class="text-sm mt-2 mb-0 message-preview">
                                        {{ message.content|truncatechars:150 }}
                                    </div>
                                    <div class="message-full collapse">
                                        <div class="text-sm mt-2 mb-0">
                                            <!-- Add debug output -->
                                            <!-- Original: {{ message.content }} -->
                                            <!-- HTML: {{ message.content_html|safe }} -->
                                            {{ message.content_html|safe }}
                                        </div>
                                    </div>
                                    {% if message.content|length > 150 %}
                                        <a href="javascript:;" class="text-xs text-primary toggle-message">Show more</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-sm mb-0">No messages yet.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        {% if execution.outputs %}
        <div class="col-12 mt-4">
            <div class="card">
                <div class="card-header pb-0">
                    <h6>Execution Outputs</h6>
                </div>
                <div class="card-body p-3">
                    <div class="messages-container" style="width: 100%; padding-left: 45px; position: relative;">
                        <!-- Timeline vertical line -->
                        <div style="position: absolute; left: 16px; top: 0; bottom: 0; width: 2px; background-color: #dee2e6;"></div>
                        
                        {% for key, value in execution.outputs.items %}
                        <div class="message-block" style="position: relative; margin-bottom: 1.5rem; width: 100%;">
                            <!-- Timeline step -->
                            <span style="position: absolute; left: -29px; width: 26px; height: 26px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; border: 2px solid #dee2e6;">
                                <i class="ni ni-key-25 text-warning text-gradient"></i>
                            </span>
                            
                            <!-- Output content -->
                            <div style="width: 100%;">
                                <div class="d-flex justify-content-between">
                                    <h6 class="text-dark text-sm font-weight-bold mb-0">{{ key }}</h6>
                                </div>
                                <div class="message-content">
                                    <div class="text-sm mt-2 mb-0 message-preview">
                                        {% if value|stringformat:"s"|length > 150 %}
                                            {{ value|stringformat:"s"|truncatechars:150 }}
                                        {% else %}
                                            {{ value|stringformat:"s" }}
                                        {% endif %}
                                    </div>
                                    <div class="message-full collapse">
                                        <div class="text-sm mt-2 mb-0">
                                            {{ execution.outputs_html|get_item:key|safe }}
                                        </div>
                                    </div>
                                    {% if value|stringformat:"s"|length > 150 %}
                                        <a href="javascript:;" class="text-xs text-primary toggle-message">Show more</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    {% include 'includes/footer.html' %}
</div>
{% endblock content %}

{% block extra_css %}
<style>
    /* Override the media query that's limiting width */
    @media (min-width: 992px) {
        .timeline-one-side .timeline-content {
            max-width: none !important;
            width: auto !important;
        }
    }

    /* Base timeline overrides */
    .timeline-one-side:before {
        left: 1rem !important;
    }

    .timeline-one-side .timeline-step {
        left: 1rem !important;
    }

    .timeline-content {
        margin-left: 45px !important;
        width: auto !important;
        float: none !important;
    }

    /* Keep other styles */
    .message-preview {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .message-full {
        margin-top: 0.5rem;
    }

    /* Add markdown styling */
    .message-content pre {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin: 1rem 0;
    }
    
    .message-content code {
        background-color: #f8f9fa;
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
        color: #e83e8c;
        font-size: 0.875em;
    }
    
    .message-content pre code {
        color: inherit;
        padding: 0;
        background-color: transparent;
    }
    
    .message-content p {
        margin-bottom: 1rem;
    }
    
    .message-content ul, 
    .message-content ol {
        margin-bottom: 1rem;
        padding-left: 2rem;
    }
    
    .message-content blockquote {
        border-left: 4px solid #dee2e6;
        padding-left: 1rem;
        margin-left: 0;
        color: #6c757d;
    }
</style>
{% endblock extra_css %}

{% block extra_js %}
{{ block.super }}
<script>
    $(document).ready(function() {
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // Initialize message toggle handlers
        $('.toggle-message').on('click', function(e) {
            e.preventDefault();
            const messageContent = $(this).closest('.message-content');
            const preview = messageContent.find('.message-preview');
            const full = messageContent.find('.message-full');
            
            if (full.hasClass('show')) {
                full.collapse('hide');
                preview.show();
                $(this).text('Show more');
            } else {
                full.collapse('show');
                preview.hide();
                $(this).text('Show less');
            }
        });
    });
</script>
{% endblock extra_js %}
