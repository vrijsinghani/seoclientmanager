{% extends 'layouts/base.html' %}
{% load static %}

{% block title %} Agent Chat {% endblock title %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header pb-0">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="agent-select" class="form-control-label">Select Agent</label>
                                <select class="form-control" id="agent-select">
                                    <option value="">Choose an agent...</option>
                                    {% for agent in agents %}
                                    <option value="{{ agent.id }}" 
                                            data-backstory="{{ agent.backstory }}"
                                            data-role="{{ agent.role }}">
                                        {{ agent.name }}
                                    </option>
                                    {% endfor %}
                                    <option value="new" class="text-primary">âž• Create New Agent</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="model-select" class="form-control-label">Select Model</label>
                                <select class="form-control" id="model-select">
                                    {% for model in models %}
                                    <option value="{{ model }}" {% if model == default_model %}selected{% endif %}>
                                        {{ model }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <!-- Agent Info Section -->
                    <div id="agent-info" class="mb-4" style="display: none;">
                        <div class="alert alert-info">
                            <h6 class="text-white"><strong>Role:</strong> <span id="agent-role"></span></h6>
                            <hr class="horizontal light">
                            <p class="text-white mb-0"><strong>Backstory:</strong> <span id="agent-backstory"></span></p>
                        </div>
                    </div>

                    <!-- Chat Messages Container -->
                    <div id="chat-messages" class="mb-4" style="height: 400px; overflow-y: auto;">
                        <!-- Messages will be inserted here -->
                    </div>

                    <!-- Chat Input -->
                    <div class="row">
                        <div class="col">
                            <div class="input-group">
                                <textarea id="message-input" class="form-control" 
                                          placeholder="Type your message..." rows="2"></textarea>
                                <button class="btn btn-primary mb-0" id="send-message">
                                    <i class="fas fa-paper-plane"></i> Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const agentSelect = document.getElementById('agent-select');
    const agentInfo = document.getElementById('agent-info');
    const agentRole = document.getElementById('agent-role');
    const agentBackstory = document.getElementById('agent-backstory');

    // Handle agent selection
    agentSelect.addEventListener('change', function() {
        if (this.value === 'new') {
            window.location.href = "{{ add_agent_url }}";
            return;
        }

        const selectedOption = this.options[this.selectedIndex];
        if (this.value) {
            agentInfo.style.display = 'block';
            agentRole.textContent = selectedOption.dataset.role;
            agentBackstory.textContent = selectedOption.dataset.backstory;
        } else {
            agentInfo.style.display = 'none';
        }
    });

    // Initialize WebSocket connection
    function connectWebSocket() {
        const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
        const chatSocket = new WebSocket(
            ws_scheme + '://' + window.location.host + '/ws/chat/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            appendMessage(data.message, data.is_agent);
        };

        return chatSocket;
    }

    // Append message to chat
    function appendMessage(message, isAgent) {
        const messagesContainer = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `d-flex ${isAgent ? 'justify-content-start' : 'justify-content-end'} mb-4`;
        
        messageDiv.innerHTML = `
            <div class="card ${isAgent ? 'bg-gray-100' : 'bg-primary text-white'}" 
                 style="max-width: 75%;">
                <div class="card-body py-2 px-3">
                    <p class="mb-0">
                        ${message}
                    </p>
                </div>
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Handle send message
    document.getElementById('send-message').addEventListener('click', function() {
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();
        
        if (message && agentSelect.value && agentSelect.value !== 'new') {
            // TODO: Send message via WebSocket
            messageInput.value = '';
        }
    });
});
</script>
{% endblock javascripts %} 