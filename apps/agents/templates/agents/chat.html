{% extends 'layouts/base.html' %}
{% load static %}

{% block title %} Agent Chat {% endblock title %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card h-100">
                <div class="card-header pb-0 d-flex justify-content-between align-items-center">
                    <div class="row flex-grow-1">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="agent-select" class="form-control-label">Select Agent</label>
                                <select class="form-control" id="agent-select">
                                    <option value="">Choose an agent...</option>
                                    {% for agent in agents %}
                                    <option value="{{ agent.id }}" 
                                            data-backstory="{{ agent.backstory }}"
                                            data-role="{{ agent.role }}">
                                        {{ agent.name }}
                                    </option>
                                    {% endfor %}
                                    <option value="new" class="text-primary">âž• Create New Agent</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="model-select" class="form-control-label">Select Model</label>
                                <select class="form-control" id="model-select">
                                    {% for model in models %}
                                    <option value="{{ model }}" {% if model == default_model %}selected{% endif %}>
                                        {{ model }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="client-select" class="form-control-label">Select Client</label>

                                <select class="form-control" id="client-select">
                                    <option value="">Choose a client...</option>
                                    {% for client in clients %}
                                    <option value="{{ client.id }}">{{ client.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="connection-status" class="ms-3" style="width: 12px; height: 12px; border-radius: 50%; background-color: #ffc107;" 
                         data-bs-toggle="tooltip" data-bs-placement="left" title="Connecting...">
                    </div>
                </div>

                <div class="card-body d-flex flex-column" style="height: calc(100vh - 300px);">
                    <!-- Agent Info Section -->
                    <div id="agent-info" class="mb-4" style="display: none;">
                        <div class="alert alert-info d-flex align-items-center cursor-pointer" data-bs-toggle="collapse" href="#agentDetails" role="button">
                            <div class="flex-grow-1">
                                <strong>Agent:</strong> <span id="agent-role-preview"></span>
                                <i class="fas fa-chevron-down ms-2"></i>
                            </div>
                        </div>
                        <div class="collapse" id="agentDetails">
                            <div class="alert alert-light">
                                <h6 class="text-dark"><strong>Role:</strong> <span id="agent-role"></span></h6>
                                <hr>
                                <p class="text-dark mb-0"><strong>Backstory:</strong> <span id="agent-backstory"></span></p>
                            </div>
                        </div>
                    </div>

                    <div id="chat-messages" class="flex-grow-1 mb-4" style="overflow-y: auto;">
                        <!-- Messages will be inserted here -->
                    </div>

                    <div class="row mt-auto">
                        <div class="col">
                            <div class="input-group">
                                <textarea id="message-input" class="form-control" 
                                          placeholder="Type your message..." rows="2"></textarea>
                                <button class="btn btn-primary mb-0" id="send-message">
                                    <i class="fas fa-paper-plane"></i> Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extrastyle %}
{{ block.super }}
<!-- Add markdown styling -->
<style>
    .markdown-content {
        font-size: 0.875rem;
    }
    
    .markdown-content h1 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
        font-weight: 600;
    }
    
    .markdown-content h2 {
        font-size: 1.25rem;
        margin-bottom: 0.875rem;
        font-weight: 600;
    }
    
    .markdown-content h3 {
        font-size: 1.125rem;
        margin-bottom: 0.75rem;
        font-weight: 600;
    }
    
    .markdown-content p {
        margin-bottom: 1rem;
    }
    
    .markdown-content ul, 
    .markdown-content ol {
        margin-bottom: 1rem;
        padding-left: 1.5rem;
    }
    
    .markdown-content code {
        background-color: #f8f9fa;
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
        font-size: 0.875em;
    }
    
    .markdown-content pre {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
        overflow-x: auto;
    }
    
    .markdown-content a {
        color: #5e72e4;
        text-decoration: none;
    }
    
    .markdown-content a:hover {
        text-decoration: underline;
    }
    
    .markdown-content blockquote {
        border-left: 4px solid #e9ecef;
        padding-left: 1rem;
        margin-left: 0;
        margin-bottom: 1rem;
        color: #6c757d;
    }
</style>
{% endblock extrastyle %}

{% block extra_js %}
{{ block.super }}
<!-- Add marked.js for markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Chat interface initializing...');
    
    const agentSelect = document.getElementById('agent-select');
    const agentInfo = document.getElementById('agent-info');
    const agentRole = document.getElementById('agent-role');
    const agentRolePreview = document.getElementById('agent-role-preview');
    const agentBackstory = document.getElementById('agent-backstory');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-message');
    let socket = null;
    let selectedAgentId = null;

    // Debug element existence
    console.log('Elements found:', {
        agentSelect: !!agentSelect,
        agentInfo: !!agentInfo,
        agentRole: !!agentRole,
        agentRolePreview: !!agentRolePreview,
        agentBackstory: !!agentBackstory,
        messageInput: !!messageInput,
        sendButton: !!sendButton
    });

    function initializeWebSocket() {
        const wsScheme = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const wsPath = `${wsScheme}${window.location.host}/ws/chat/`;
        
        console.log('Initializing WebSocket connection to:', wsPath);
        
        try {
            if (socket) {
                console.log('Closing existing socket connection');
                socket.close();
            }
            
            socket = new WebSocket(wsPath);
            
            socket.onopen = function(e) {
                console.log('WebSocket connection established!');
                updateConnectionStatus('Connected');
                sendButton.classList.remove('disabled');
            };

            socket.onmessage = function(event) {
                console.log('WebSocket message received:', event.data);
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };

            socket.onclose = function(event) {
                console.log('WebSocket connection closed:', event.code, event.reason);
                updateConnectionStatus('Disconnected - Retrying...', true);
                sendButton.classList.add('disabled');
                setTimeout(initializeWebSocket, 5000);
            };

            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateConnectionStatus('Connection Error', true);
            };
        } catch (error) {
            console.error('Error creating WebSocket:', error);
            updateConnectionStatus('Failed to create connection', true);
        }
    }

    // Initialize WebSocket when page loads
    console.log('Starting WebSocket initialization...');
    initializeWebSocket();

    // Handle agent selection with debug logging
    agentSelect.addEventListener('change', function() {
        selectedAgentId = this.value;
        console.log('Agent selected:', selectedAgentId);
        
        if (this.value === 'new') {
            window.location.href = "{{ add_agent_url }}";
            return;
        }

        const selectedOption = this.options[this.selectedIndex];
        if (selectedAgentId) {
            console.log('Showing agent info for:', selectedOption.text);
            agentInfo.style.display = 'block';
            agentRole.textContent = selectedOption.dataset.role;
            agentRolePreview.textContent = selectedOption.dataset.role.split('\n')[0];
            agentBackstory.textContent = selectedOption.dataset.backstory;
        } else {
            console.log('Hiding agent info');
            agentInfo.style.display = 'none';
            selectedAgentId = null;
        }
    });

    // Add message sending functionality with debug logging
    function sendMessage() {
        const message = messageInput.value.trim();
        const modelName = document.getElementById('model-select').value;
        const clientId = document.getElementById('client-select').value;  // Get selected client ID
        
        console.log('Send attempt:', {
            message,
            selectedAgentId,
            model: modelName,
            clientId,  // Log client ID
            socketState: socket?.readyState,
            hasMessage: !!message,
            hasAgent: !!selectedAgentId,
            socketOpen: socket?.readyState === WebSocket.OPEN
        });
        
        if (!selectedAgentId) {
            alert('Please select an agent first');
            return;
        }
        
        if (!message) {
            return;
        }
        
        if (socket?.readyState !== WebSocket.OPEN) {
            alert('Connection lost. Reconnecting...');
            initializeWebSocket();
            return;
        }
        
        const payload = {
            message: message,
            agent_id: selectedAgentId,
            model: modelName,
            client_id: clientId  // Include client ID in payload
        };
        
        console.log('Sending message:', payload);
        socket.send(JSON.stringify(payload));
        
        // Show user message immediately
        appendMessage(message, false);
        messageInput.value = '';
    }

    // Add event listeners with debug logging
    sendButton.addEventListener('click', function() {
        console.log('Send button clicked');
        sendMessage();
    });

    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            console.log('Enter key pressed');
            e.preventDefault();
            sendMessage();
        }
    });

    // Add the missing functions
    function updateConnectionStatus(message, isError = false) {
        const connectionStatus = document.getElementById('connection-status');
        connectionStatus.style.backgroundColor = isError ? '#dc3545' : '#28a745';
        connectionStatus.setAttribute('title', message);
        // Reinitialize tooltips
        var tooltip = new bootstrap.Tooltip(connectionStatus);
    }

    function appendMessage(message, isAgent) {
        const messagesContainer = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `d-flex ${isAgent ? 'justify-content-start' : 'justify-content-end'} mb-4`;
        
        // Parse markdown if it's an agent message
        const messageContent = isAgent ? marked.parse(message) : message;
        
        messageDiv.innerHTML = `
            <div class="card ${isAgent ? 'bg-gray-100' : 'bg-primary text-white'}" 
                 style="max-width: 75%;">
                <div class="card-body py-2 px-3">
                    <div class="markdown-content">
                        ${messageContent}
                    </div>
                </div>
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function handleWebSocketMessage(data) {
        console.log('Handling WebSocket message:', data);
        
        if (data.error) {
            updateConnectionStatus(data.message, true);
            return;
        }
        
        if (data.message) {
            appendMessage(data.message, data.is_agent);
        }
    }
});

// Initialize tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
});
</script>
{% endblock extra_js %} 