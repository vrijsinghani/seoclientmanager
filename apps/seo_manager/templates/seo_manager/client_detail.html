{% extends "layouts/base.html" %}
{% load static %}

{% load custom_filters %}

{% block title %} Client Detail - {{ client.name }} {% endblock %}

{% block content %}

<div class="container-fluid py-4">
  <div class="row">
    <div class="col-md-5">
      <div class="card mb-4">
        <div class="card-header pb-0 d-flex justify-content-between align-items-center">
          <h6>Client Details: {{ client.name }}</h6>
          <a href="{% url 'seo_manager:edit_client' client.id %}" class="btn btn-xxs btn-primary">Edit</a>
        </div>
        <div class="card-body px-0 pt-0 pb-2">
          <div class="table-responsive p-0">
            <table class="table align-items-center mb-0">
              <tbody>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Website URL</td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ client.website_url }}</p>
                  </td>
                </tr>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Status</td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ client.get_status_display }}</p>
                  </td>
                </tr>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Group</td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ client.group.name|default:"N/A" }}</p>
                  </td>
                </tr>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Target Audience</td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ client.target_audience|default:"N/A" }}</p>
                  </td>
                </tr>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Created At</td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ client.created_at|date:"F d, Y H:i" }}</p>
                  </td>
                </tr>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Last Updated</td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ client.updated_at|date:"F d, Y H:i" }}</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-7">
      <div class="card mb-4">
        <div class="card-header pb-0">
          <h6>Business Objectives</h6>
        </div>
        <div class="card-body p-3">
          <div class="timeline timeline-one-side">
            {% for objective in business_objectives %}
              <div class="timeline-block mb-3">
                <span class="timeline-step">
                  <i class="ni ni-bell-55 text-success text-gradient"></i>
                </span>
                <div class="timeline-content">
                  <h6 class="text-dark text-sm font-weight-bold mb-0">{{ objective.goal }}</h6>
                  <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">Metric: {{ objective.metric }}</p>
                  <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">Target Date: {{ objective.target_date }}</p>
                  <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">Status: {% if objective.status %}Active{% else %}Inactive{% endif %}</p>
                  <p class="text-secondary text-sm mt-3 mb-2">
                    Created: {{ objective.date_created|format_iso_date:"%Y-%m-%d %H:%M" }} | Last Modified: {{ objective.date_last_modified|format_iso_date:"%Y-%m-%d %H:%M" }}
                  </p>
                  <div class="mt-3">
                    <a href="{% url 'seo_manager:edit_business_objective' client.id forloop.counter0 %}" class="btn btn-sm btn-primary">Edit</a>
                    <form method="post" action="{% url 'seo_manager:delete_business_objective' client.id forloop.counter0 %}" style="display: inline;">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this objective?')">Delete</button>
                    </form>
                  </div>
                </div>
              </div>
            {% empty %}
              <p style="padding-left: 20px;">No business objectives set for this client.</p>
            {% endfor %}
          </div>
          
          <div class="mt-4">
            <h6>Add New Business Objective</h6>
            <form method="post" action="{% url 'seo_manager:add_business_objective' client.id %}" class="row g-3 align-items-center">
              {% csrf_token %}
              <div class="col-auto">
                {{ form.goal }}
              </div>
              <div class="col-auto">
                {{ form.metric }}
              </div>
              <div class="col-auto">
                {{ form.target_date }}
              </div>
              <div class="col-auto">
                <div class="form-check">
                  {{ form.status }}
                  <label class="form-check-label" for="{{ form.status.id_for_label }}">
                    Active
                  </label>
                </div>
              </div>
              <div class="col-auto">
                <button type="submit" class="btn btn-primary">Add Objective</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Targeted Keywords Section -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header pb-0">
        <div class="d-lg-flex">
          <div>
            <h5 class="mb-0">Targeted Keywords</h5>
            <p class="text-sm mb-0">
              Manage keywords and track their performance
            </p>
          </div>
          <div class="ms-auto my-auto mt-lg-0 mt-4">
            <div class="ms-auto my-auto">
              <button type="button" class="btn bg-gradient-primary btn-sm mb-0" data-bs-toggle="modal" data-bs-target="#add-keyword">
                <i class="fas fa-plus"></i>&nbsp;&nbsp;Add Keyword
              </button>
              <button type="button" class="btn btn-outline-primary btn-sm mb-0" data-bs-toggle="modal" data-bs-target="#import-keywords">
                Import CSV
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body px-0 pb-0">
        <div class="table-responsive">
          {% include 'seo_manager/keywords/keyword_list_table.html' with keywords=client.targeted_keywords.all %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SEO Projects Section -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header pb-0">
        <div class="d-lg-flex">
          <div>
            <h5 class="mb-0">SEO Projects</h5>
            <p class="text-sm mb-0">
              Track and manage SEO implementation projects
            </p>
          </div>
          <div class="ms-auto my-auto mt-lg-0 mt-4">
            <div class="ms-auto my-auto">
              <button type="button" class="btn bg-gradient-primary btn-sm mb-0" data-bs-toggle="modal" data-bs-target="#add-project">
                <i class="fas fa-plus"></i>&nbsp;&nbsp;New Project
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body px-0 pb-0">
        <div class="table-responsive">
          {% include 'seo_manager/projects/project_list_table.html' with projects=client.seo_projects.all %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Keyword Modal -->
<div class="modal fade" id="add-keyword" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Keyword</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'seo_manager:keyword_create' client.id %}">
        {% csrf_token %}
        <div class="modal-body">
          {{ keyword_form.as_p }}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn bg-gradient-primary">Add Keyword</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Import Keywords Modal -->
<div class="modal fade" id="import-keywords" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Import Keywords</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'seo_manager:keyword_import' client.id %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-body">
          {{ import_form.as_p }}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn bg-gradient-primary">Import</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Project Modal -->
<div class="modal fade" id="add-project" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">New SEO Project</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'seo_manager:project_create' client.id %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-body">
          {{ project_form.as_p }}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn bg-gradient-primary">Create Project</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add this after the client details card and before the business objectives -->
<div class="col-md-12">
  <div class="card mb-4 mt-4">
    <div class="card-header pb-0 d-flex justify-content-between align-items-center">
      <div>
        <h5>Client Profile</h5>
        <p class="text-sm text-muted mb-0">Background information on client</p>
      </div>
      {% if client.client_profile %}
        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#edit-profile">
          Edit Profile
        </button>
      {% else %}
        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#add-profile">
          Add Profile
        </button>
      {% endif %}
    </div>
    
    <div class="card-body">
      {% if client_profile_html %}
        <div class="markdown-content">
          {{ client_profile_html|safe }}
        </div>
      {% else %}
        <p class="text-sm text-muted">No profile has been added for this client yet.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Add Profile Modal -->
<div class="modal fade" id="add-profile" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Client Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'seo_manager:update_client_profile' client.id %}" id="addProfileForm">
        {% csrf_token %}
        <div class="modal-body">
          <div id="add-profile-editor" class="h-300">
            {{ client.client_profile|default:"" }}
          </div>
          <input type="hidden" name="client_profile" id="add-profile-content">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn bg-gradient-primary">Save Profile</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="edit-profile" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Client Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'seo_manager:update_client_profile' client.id %}" id="editProfileForm">
        {% csrf_token %}
        <div class="modal-body">
          <div id="edit-profile-editor" class="h-300">
            {{ client.client_profile|safe }}
          </div>
          <input type="hidden" name="client_profile" id="edit-profile-content">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn bg-gradient-primary">Update Profile</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Project Details Modals -->
{% for project in client.seo_projects.all %}
<div class="modal fade" id="view-project-{{ project.id }}" tabindex="-1" role="dialog" aria-labelledby="project-modal-{{ project.id }}" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="project-modal-{{ project.id }}">{{ project.title }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-12">
            <h6 class="text-sm">Description</h6>
            <p class="text-sm text-muted">{{ project.description }}</p>
          </div>
        </div>
        
        <div class="row mt-3">
          <div class="col-md-12">
            <h6 class="text-sm">Status</h6>
            <span class="badge bg-gradient-{% if project.status == 'completed' %}success{% elif project.status == 'in_progress' %}info{% elif project.status == 'planned' %}secondary{% else %}warning{% endif %}">
              {{ project.get_status_display }}
            </span>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-6">
            <h6 class="text-sm">Implementation Date</h6>
            <p class="text-sm">{{ project.implementation_date }}</p>
          </div>
          <div class="col-md-6">
            <h6 class="text-sm">Completion Date</h6>
            <p class="text-sm">{{ project.completion_date|default:"Not set" }}</p>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-12">
            <h6 class="text-sm">Targeted Keywords</h6>
            <div class="d-flex flex-wrap gap-2">
              {% for keyword in project.targeted_keywords.all %}
                <span class="badge bg-light text-dark">{{ keyword.keyword }}</span>
              {% empty %}
                <p class="text-sm text-muted">No keywords assigned</p>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <a href="{% url 'seo_manager:edit_project' client.id project.id %}" class="btn bg-gradient-primary btn-sm">Edit Project</a>
        <form method="post" action="{% url 'seo_manager:delete_project' client.id project.id %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn bg-gradient-danger btn-sm" onclick="return confirm('Are you sure you want to delete this project?')">Delete Project</button>
        </form>
        <button type="button" class="btn bg-gradient-secondary btn-sm" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<!-- Add this after the Targeted Keywords Section -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header pb-0">
        <div class="d-lg-flex">
          <div>
            <h5 class="mb-0">Ranking Data Management</h5>
            <p class="text-sm mb-0">
              Manage Search Console data collection and reporting
              <a href="{% url 'seo_manager:ranking_data_management' client.id %}" class="text-primary">View Details</a>
            </p>
          </div>
          <div class="ms-auto my-auto mt-lg-0 mt-4">
            <div class="ms-auto my-auto">
              <button type="button" class="btn bg-gradient-primary btn-sm mb-0" id="collectRankingsBtn">
                <i class="fas fa-sync"></i>&nbsp;&nbsp;Collect Latest Rankings
              </button>
              <button type="button" class="btn bg-gradient-info btn-sm mb-0" id="generateReportBtn">
                <i class="fas fa-file-alt"></i>&nbsp;&nbsp;Generate Report
              </button>
              <button type="button" class="btn btn-outline-primary btn-sm mb-0" id="backfillRankingsBtn">
                Backfill Historical Data
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body px-0 pb-0">
        <div class="table-responsive">
          <table class="table align-items-center mb-0">
            <thead>
              <tr>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-3">Last Collection</th>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-3">Data Coverage</th>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-3">Keywords Tracked</th>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-3">Status</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="ps-3">
                  <span class="text-sm">
                    {% if latest_collection_date %}
                      {{ latest_collection_date|date:"F d, Y" }}
                    {% else %}
                      No data collected yet
                    {% endif %}
                  </span>
                </td>
                <td class="ps-3">
                  <span class="text-sm">
                    {% if data_coverage_months %}
                      {{ data_coverage_months }} month{{ data_coverage_months|pluralize }}
                    {% else %}
                      -
                    {% endif %}
                  </span>
                </td>
                <td class="ps-3">
                  <span class="text-sm">
                    {% if tracked_keywords_count %}
                      {{ tracked_keywords_count }}
                    {% else %}
                      0
                    {% endif %}
                  </span>
                </td>
                <td class="ps-3">
                  {% if latest_collection_date %}
                    <span class="badge badge-sm bg-gradient-success">Active</span>
                  {% else %}
                    <span class="badge badge-sm bg-gradient-warning">No Data</span>
                  {% endif %}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add the Report Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">SEO Performance Report</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="reportContent">
          <!-- Report content will be loaded here -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Client Activity Timeline --> 
  <div class="row mt-4">
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header pb-0">
          <h6>Client Activity Timeline</h6>
        </div>
        <div class="card-body p-3">
          <div class="timeline timeline-one-side" data-timeline-axis-style="dotted">
            {% for activity in client_activities %}
              <div class="timeline-block mb-3">
                <span class="timeline-step">
                  <i class="ni ni-bell-55 text-success text-gradient"></i>
                </span>
                <div class="timeline-content">
                  <p class="text-sm mb-0">
                    <span class="font-weight-bold">{{ activity.timestamp|date:"d M Y H:i" }}</span> - 
                    <span class="text-primary">{{ activity.user.username }}</span> 
                    {{ activity.action }} 
                    <span class="badge badge-sm bg-gradient-{{ activity.category }}">{{ activity.get_category_display }}</span>
                  </p>
                  {% if activity.details %}
                    <div class="mt-0">
                      <pre class="text-xs">{{ activity.details|pprint }}</pre>
                    </div>
                  {% endif %}
                </div>
              </div>
            {% empty %}
              <p style="padding-left: 20px;">No activity recorded for this client.</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      {% if client.ga_credentials %}
      <div class="card mb-4">
        <div class="card-header pb-0 d-flex justify-content-between align-items-center">
          <h6>Google Analytics Credentials</h6>
          <a href="{% url 'seo_manager:remove_ga_credentials' client.id %}" class="btn btn-sm btn-danger">Remove Credentials</a>
        </div>
        <div class="card-body px-0 pt-0 pb-2">
          <div class="table-responsive p-0">
            <table class="table align-items-center mb-0">
              <tbody>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">View ID</td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ client.ga_credentials.view_id }}</p>
                  </td>
                </tr>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">GA Client ID</td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ client.ga_credentials.ga_client_id }}</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% else %}
      <div class="card mb-4">
        <div class="card-header pb-0">
          <h6>Google Analytics Credentials</h6>
        </div>
        <div class="card-body">
          <p>No Google Analytics credentials are set for this client.</p>
          <a href="{% url 'seo_manager:add_ga_credentials_oauth' client.id %}" class="btn btn-primary">Add GA Credentials (OAuth)</a>
          <a href="{% url 'seo_manager:add_ga_credentials_service_account' client.id %}" class="btn btn-secondary">Add GA Credentials (Service Account)</a>
        </div>
      </div>
      {% endif %}

      {% if client.sc_credentials %}
      <div class="card mb-4">
        <div class="card-header pb-0 d-flex justify-content-between align-items-center">
          <h6>Search Console Credentials</h6>
          <a href="{% url 'seo_manager:remove_sc_credentials' client.id %}" class="btn btn-sm btn-danger">Remove Credentials</a>
        </div>
        <div class="card-body px-0 pt-0 pb-2">
          <div class="table-responsive p-0">
            <table class="table align-items-center mb-0">
              <tbody>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Property URL</td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ client.sc_credentials.property_url }}</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% else %}
      <div class="card mb-4">
        <div class="card-header pb-0">
          <h6>Search Console Credentials</h6>
        </div>
        <div class="card-body">
          <p>No Search Console credentials are set for this client.</p>
          <a href="{% url 'seo_manager:add_sc_credentials' client.id %}" class="btn btn-primary">Add Search Console Credentials</a>
        </div>
      </div>
      {% endif %}

      <!-- Add this section below the Search Console Credentials section -->

      <div class="card mb-4">
        <div class="card-header pb-0 d-flex justify-content-between align-items-center">
          <h6>Meta-Tags</h6>
          <a href="#" id="createSnapshotBtn" class="btn btn-sm btn-primary">Create Snapshot</a>
        </div>
        <div class="card-body px-0 pt-0 pb-2">
          <div class="table-responsive p-0">
            <table class="table align-items-center mb-0">
              <tbody>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Latest Snapshot</td>
                  <td>
                    {% if meta_tags_files %}
                      <p class="text-xs font-weight-bold mb-0">{{ meta_tags_files.0 }}</p>
                    {% else %}
                      <p class="text-xs font-weight-bold mb-0">No snapshots available</p>
                    {% endif %}
                  </td>
                </tr>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Actions</td>
                  <td>
                    <a href="{% url 'file_manager' %}/meta-tags" class="btn btn-sm btn-secondary">View All Snapshots</a>
                    {% if meta_tags_files %}
                      <a href="{% url 'download_file' file_path=meta_tags_files.0 %}" class="btn btn-sm btn-info">Download Latest</a>
                    {% endif %}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>


  <!-- Add Delete Client Button -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-body">
          <button id="deleteClientBtn" class="btn btn-danger">Delete Client</button>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Add this after the existing cards in client_detail.html -->


{% endblock content %}
{% block extra_css %}
<style>
  .h-300 {
    height: 300px !important;
  }
  
  .ql-editor {
    min-height: 200px;
  }
  </style>

<!-- Add some CSS for markdown content -->
<style>
  .markdown-content {
    font-size: 0.875rem;
  }
  
  .markdown-content h1 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    font-weight: 600;
  }
  
  .markdown-content h2 {
    font-size: 1.25rem;
    margin-bottom: 0.875rem;
    font-weight: 600;
  }
  
  .markdown-content h3 {
    font-size: 1.125rem;
    margin-bottom: 0.75rem;
    font-weight: 600;
  }
  
  .markdown-content p {
    margin-bottom: 1rem;
  }
  
  .markdown-content ul, 
  .markdown-content ol {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
  }
  
  .markdown-content code {
    background-color: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
  }
  
  .markdown-content pre {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
    overflow-x: auto;
  }
  
  .markdown-content a {
    color: #5e72e4;
    text-decoration: none;
  }
  
  .markdown-content a:hover {
    text-decoration: underline;
  }
  
  .markdown-content blockquote {
    border-left: 4px solid #e9ecef;
    padding-left: 1rem;
    margin-left: 0;
    margin-bottom: 1rem;
    color: #6c757d;
  }
  </style>
{% endblock extra_css %}

{% block extra_js %}
{{ block.super }}

<!-- Add Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'assets/js/plugins/quill.min.js' %}"></script>
<!-- Add this after your existing extra_js content -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% for keyword in client.targeted_keywords.all %}
    (function() {
        const modal = document.getElementById('view-history-{{ keyword.id }}');
        if (!modal) return;

        // Debug log to see what data we have
        console.log('Keyword: {{ keyword.keyword }}');
        
        const history = [
            {% for entry in keyword.ranking_history.all %}
                {
                    date: '{{ entry.date|date:"M d, Y" }}',
                    position: {{ entry.average_position }},
                    impressions: {{ entry.impressions }},
                    clicks: {{ entry.clicks }},
                    ctr: {{ entry.ctr }}
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        // Debug log to see the history array
        console.log('History data:', history);

        modal.addEventListener('show.bs.modal', function() {
            const ctx = document.getElementById('keyword-chart-{{ keyword.id }}');
            if (!ctx) {
                console.error('Canvas not found for keyword {{ keyword.id }}');
                return;
            }

            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: history.map(entry => entry.date),
                    datasets: [{
                        label: 'Position',
                        data: history.map(entry => entry.position),
                        borderColor: '#5e72e4',
                        backgroundColor: 'rgba(94, 114, 228, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            reverse: true,
                            beginAtZero: false
                        }
                    }
                }
            });

            modal._chart = chart;
        });

        modal.addEventListener('hidden.bs.modal', function() {
            if (modal._chart) {
                modal._chart.destroy();
                modal._chart = null;
            }
        });
    })();
    {% endfor %}
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Collect Rankings Button
  document.getElementById('collectRankingsBtn').addEventListener('click', function() {
    Swal.fire({
      title: 'Collecting Rankings Data',
      text: 'This may take a few minutes...',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading()
      }
    });

    fetch('{% url "seo_manager:collect_rankings" client.id %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: data.message
        }).then(() => {
          window.location.reload();
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: data.error
        });
      }
    });
  });

  // Generate Report Button
  document.getElementById('generateReportBtn').addEventListener('click', function() {
    Swal.fire({
      title: 'Generating Report',
      text: 'Please wait...',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading()
      }
    });

    fetch('{% url "seo_manager:generate_report" client.id %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('reportContent').innerHTML = data.report_html;
        var reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
        Swal.close();
        reportModal.show();
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: data.error
        });
      }
    });
  });

  // Backfill Rankings Button
  document.getElementById('backfillRankingsBtn').addEventListener('click', function() {
    Swal.fire({
      title: 'Backfill Historical Data',
      text: 'This will collect ranking data for the past 12 months. This may take several minutes. Continue?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Yes, proceed',
      cancelButtonText: 'No, cancel'
    }).then((result) => {
      if (result.isConfirmed) {
        Swal.fire({
          title: 'Collecting Historical Data',
          text: 'This may take several minutes...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading()
          }
        });

        fetch('{% url "seo_manager:backfill_rankings" client.id %}', {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: data.message
            }).then(() => {
              window.location.reload();
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: data.error
            });
          }
        });
      }
    });
  });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize Quill editors
  var toolbarOptions = [
    ['bold', 'italic', 'underline', 'strike'],
    ['blockquote', 'code-block'],
    [{ 'header': 1 }, { 'header': 2 }],
    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
    [{ 'script': 'sub'}, { 'script': 'super' }],
    [{ 'indent': '-1'}, { 'indent': '+1' }],
    ['link'],
    ['clean']
  ];

  // Add Profile Editor
  if (document.getElementById('add-profile-editor')) {
    var addProfileEditor = new Quill('#add-profile-editor', {
      theme: 'snow',
      modules: {
        toolbar: toolbarOptions
      }
    });

    // Handle form submission
    document.getElementById('addProfileForm').addEventListener('submit', function(e) {
      var content = addProfileEditor.root.innerHTML;
      document.getElementById('add-profile-content').value = content;
    });
  }

  // Edit Profile Editor
  if (document.getElementById('edit-profile-editor')) {
    var editProfileEditor = new Quill('#edit-profile-editor', {
      theme: 'snow',
      modules: {
        toolbar: toolbarOptions
      }
    });

    // Handle form submission
    document.getElementById('editProfileForm').addEventListener('submit', function(e) {
      var content = editProfileEditor.root.innerHTML;
      document.getElementById('edit-profile-content').value = content;
    });
  }
});
</script>

{% endblock extra_js %}
