{% extends "layouts/base.html" %}

{% load custom_filters %}

{% block title %} Client Detail - {{ client.name }} {% endblock %}

{% block content %}

<div class="container-fluid py-4">
  <div class="row">
    <div class="col-md-5">
      <div class="card mb-4">
        <div class="card-header pb-0 d-flex justify-content-between align-items-center">
          <h6>Client Details: {{ client.name }}</h6>
          <a href="{% url 'seo_manager:edit_client' client.id %}" class="btn btn-xxs btn-primary">Edit</a>
        </div>
        <div class="card-body px-0 pt-0 pb-2">
          <div class="table-responsive p-0">
            <table class="table align-items-center mb-0">
              <tbody>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Website URL</td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ client.website_url }}</p>
                  </td>
                </tr>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Status</td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ client.get_status_display }}</p>
                  </td>
                </tr>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Group</td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ client.group.name|default:"N/A" }}</p>
                  </td>
                </tr>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Target Audience</td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ client.target_audience|default:"N/A" }}</p>
                  </td>
                </tr>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Created At</td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ client.created_at|date:"F d, Y H:i" }}</p>
                  </td>
                </tr>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Last Updated</td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ client.updated_at|date:"F d, Y H:i" }}</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-7">
      <div class="card mb-4">
        <div class="card-header pb-0">
          <h6>Business Objectives</h6>
        </div>
        <div class="card-body p-3">
          <div class="timeline timeline-one-side">
            {% for objective in business_objectives %}
              <div class="timeline-block mb-3">
                <span class="timeline-step">
                  <i class="ni ni-bell-55 text-success text-gradient"></i>
                </span>
                <div class="timeline-content">
                  <h6 class="text-dark text-sm font-weight-bold mb-0">{{ objective.goal }}</h6>
                  <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">Metric: {{ objective.metric }}</p>
                  <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">Target Date: {{ objective.target_date }}</p>
                  <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">Status: {% if objective.status %}Active{% else %}Inactive{% endif %}</p>
                  <p class="text-secondary text-sm mt-3 mb-2">
                    Created: {{ objective.date_created|format_iso_date:"%Y-%m-%d %H:%M" }} | Last Modified: {{ objective.date_last_modified|format_iso_date:"%Y-%m-%d %H:%M" }}
                  </p>
                  <div class="mt-3">
                    <a href="{% url 'seo_manager:edit_business_objective' client.id forloop.counter0 %}" class="btn btn-sm btn-primary">Edit</a>
                    <form method="post" action="{% url 'seo_manager:delete_business_objective' client.id forloop.counter0 %}" style="display: inline;">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this objective?')">Delete</button>
                    </form>
                  </div>
                </div>
              </div>
            {% empty %}
              <p style="padding-left: 20px;">No business objectives set for this client.</p>
            {% endfor %}
          </div>
          
          <div class="mt-4">
            <h6>Add New Business Objective</h6>
            <form method="post" class="row g-3 align-items-center">
              {% csrf_token %}
              <div class="col-auto">
                {{ form.goal }}
              </div>
              <div class="col-auto">
                {{ form.metric }}
              </div>
              <div class="col-auto">
                {{ form.target_date }}
              </div>
              <div class="col-auto">
                <div class="form-check">
                  {{ form.status }}
                  <label class="form-check-label" for="{{ form.status.id_for_label }}">
                    Active
                  </label>
                </div>
              </div>
              <div class="col-auto">
                <button type="submit" class="btn btn-primary">Add Objective</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header pb-0">
          <h6>Client Activity Timeline</h6>
        </div>
        <div class="card-body p-3">
          <div class="timeline timeline-one-side" data-timeline-axis-style="dotted">
            {% for activity in client_activities %}
              {% if activity.category in 'create,update,delete,export,import,other' %}
                <div class="timeline-block mb-3">
                  <span class="timeline-step">
                    <i class="ni ni-bell-55 text-success text-gradient"></i>
                  </span>
                  <div class="timeline-content">
                    <p class="text-sm mb-0">
                      <span class="font-weight-bold">{{ activity.timestamp|date:"d M Y H:i" }}</span> - 
                      <span class="text-primary">{{ activity.user.username }}</span> 
                      {{ activity.action }} 
                      <span class="badge badge-sm bg-gradient-{{ activity.category }}">{{ activity.get_category_display }}</span>
                    </p>
                    {% if activity.details %}
                      <div class="mt-0">
                        <pre class="text-xs">{{ activity.details|pprint }}</pre>
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endif %}
            {% empty %}
              <p style="padding-left: 20px;">No activity recorded for this client.</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      {% if client.ga_credentials %}
      <div class="card mb-4">
        <div class="card-header pb-0 d-flex justify-content-between align-items-center">
          <h6>Google Analytics Credentials</h6>
          <a href="{% url 'seo_manager:remove_ga_credentials' client.id %}" class="btn btn-sm btn-danger">Remove Credentials</a>
        </div>
        <div class="card-body px-0 pt-0 pb-2">
          <div class="table-responsive p-0">
            <table class="table align-items-center mb-0">
              <tbody>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">View ID</td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ client.ga_credentials.view_id }}</p>
                  </td>
                </tr>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">GA Client ID</td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ client.ga_credentials.ga_client_id }}</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% else %}
      <div class="card mb-4">
        <div class="card-header pb-0">
          <h6>Google Analytics Credentials</h6>
        </div>
        <div class="card-body">
          <p>No Google Analytics credentials are set for this client.</p>
          <a href="{% url 'seo_manager:add_ga_credentials_oauth' client.id %}" class="btn btn-primary">Add GA Credentials (OAuth)</a>
          <a href="{% url 'seo_manager:add_ga_credentials_service_account' client.id %}" class="btn btn-secondary">Add GA Credentials (Service Account)</a>
        </div>
      </div>
      {% endif %}

      {% if client.sc_credentials %}
      <div class="card mb-4">
        <div class="card-header pb-0 d-flex justify-content-between align-items-center">
          <h6>Search Console Credentials</h6>
          <a href="{% url 'seo_manager:remove_sc_credentials' client.id %}" class="btn btn-sm btn-danger">Remove Credentials</a>
        </div>
        <div class="card-body px-0 pt-0 pb-2">
          <div class="table-responsive p-0">
            <table class="table align-items-center mb-0">
              <tbody>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Property URL</td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ client.sc_credentials.property_url }}</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% else %}
      <div class="card mb-4">
        <div class="card-header pb-0">
          <h6>Search Console Credentials</h6>
        </div>
        <div class="card-body">
          <p>No Search Console credentials are set for this client.</p>
          <a href="{% url 'seo_manager:add_sc_credentials' client.id %}" class="btn btn-primary">Add Search Console Credentials</a>
        </div>
      </div>
      {% endif %}

      <!-- Add this section below the Search Console Credentials section -->

      <div class="card mb-4">
        <div class="card-header pb-0 d-flex justify-content-between align-items-center">
          <h6>Meta-Tags</h6>
          <a href="#" id="createSnapshotBtn" class="btn btn-sm btn-primary">Create Snapshot</a>
        </div>
        <div class="card-body px-0 pt-0 pb-2">
          <div class="table-responsive p-0">
            <table class="table align-items-center mb-0">
              <tbody>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Latest Snapshot</td>
                  <td>
                    {% if meta_tags_files %}
                      <p class="text-xs font-weight-bold mb-0">{{ meta_tags_files.0 }}</p>
                    {% else %}
                      <p class="text-xs font-weight-bold mb-0">No snapshots available</p>
                    {% endif %}
                  </td>
                </tr>
                <tr>
                  <td class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Actions</td>
                  <td>
                    <a href="{% url 'file_manager' %}/meta-tags" class="btn btn-sm btn-secondary">View All Snapshots</a>
                    {% if meta_tags_files %}
                      <a href="{% url 'download_file' file_path=meta_tags_files.0 %}" class="btn btn-sm btn-info">Download Latest</a>
                    {% endif %}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>


  <!-- Add Delete Client Button -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-body">
          <button id="deleteClientBtn" class="btn btn-danger">Delete Client</button>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Add this after the existing cards in client_detail.html -->

<!-- Targeted Keywords Section -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header pb-0">
        <div class="d-lg-flex">
          <div>
            <h5 class="mb-0">Targeted Keywords</h5>
            <p class="text-sm mb-0">
              Manage keywords and track their performance
            </p>
          </div>
          <div class="ms-auto my-auto mt-lg-0 mt-4">
            <div class="ms-auto my-auto">
              <button type="button" class="btn bg-gradient-primary btn-sm mb-0" data-bs-toggle="modal" data-bs-target="#add-keyword">
                <i class="fas fa-plus"></i>&nbsp;&nbsp;Add Keyword
              </button>
              <button type="button" class="btn btn-outline-primary btn-sm mb-0" data-bs-toggle="modal" data-bs-target="#import-keywords">
                Import CSV
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body px-0 pb-0">
        <div class="table-responsive">
          {% include 'seo_manager/keywords/keyword_list_table.html' with keywords=client.targeted_keywords.all %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SEO Projects Section -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header pb-0">
        <div class="d-lg-flex">
          <div>
            <h5 class="mb-0">SEO Projects</h5>
            <p class="text-sm mb-0">
              Track and manage SEO implementation projects
            </p>
          </div>
          <div class="ms-auto my-auto mt-lg-0 mt-4">
            <div class="ms-auto my-auto">
              <button type="button" class="btn bg-gradient-primary btn-sm mb-0" data-bs-toggle="modal" data-bs-target="#add-project">
                <i class="fas fa-plus"></i>&nbsp;&nbsp;New Project
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body px-0 pb-0">
        <div class="table-responsive">
          {% include 'seo_manager/projects/project_list_table.html' with projects=client.seo_projects.all %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Keyword Modal -->
<div class="modal fade" id="add-keyword" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Keyword</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'seo_manager:keyword_create' client.id %}">
        {% csrf_token %}
        <div class="modal-body">
          {{ keyword_form.as_p }}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn bg-gradient-primary">Add Keyword</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Import Keywords Modal -->
<div class="modal fade" id="import-keywords" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Import Keywords</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'seo_manager:keyword_import' client.id %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-body">
          {{ import_form.as_p }}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn bg-gradient-primary">Import</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Project Modal -->
<div class="modal fade" id="add-project" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">New SEO Project</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'seo_manager:project_create' client.id %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-body">
          {{ project_form.as_p }}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn bg-gradient-primary">Create Project</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add this after the client details card and before the business objectives -->
<div class="col-md-12">
  <div class="card mb-4 mt-4">
    <div class="card-header pb-0 d-flex justify-content-between align-items-center">
      <div>
        <h5>Client Profile</h5>
        <p class="text-sm text-muted mb-0">Background information on client</p>
      </div>
      {% if client.client_profile %}
        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#edit-profile">
          Edit Profile
        </button>
      {% else %}
        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#add-profile">
          Add Profile
        </button>
      {% endif %}
    </div>
    
    <div class="card-body">
      {% if client.client_profile %}
        <p class="text-sm">{{ client.client_profile|linebreaks }}</p>
      {% else %}
        <p class="text-sm text-muted">No profile has been added for this client yet.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Add Profile Modal -->
<div class="modal fade" id="add-profile" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Client Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'seo_manager:update_client_profile' client.id %}">
        {% csrf_token %}
        <div class="modal-body">
          {{ profile_form.client_profile }}
          <small class="form-text text-muted">{{ profile_form.client_profile.help_text }}</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn bg-gradient-primary">Save Profile</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="edit-profile" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Client Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{% url 'seo_manager:update_client_profile' client.id %}">
        {% csrf_token %}
        <div class="modal-body">
          {{ profile_form.client_profile }}
          <small class="form-text text-muted">{{ profile_form.client_profile.help_text }}</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn bg-gradient-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn bg-gradient-primary">Update Profile</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Project Details Modals -->
{% for project in client.seo_projects.all %}
<div class="modal fade" id="view-project-{{ project.id }}" tabindex="-1" role="dialog" aria-labelledby="project-modal-{{ project.id }}" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="project-modal-{{ project.id }}">{{ project.title }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-12">
            <h6 class="text-sm">Description</h6>
            <p class="text-sm text-muted">{{ project.description }}</p>
          </div>
        </div>
        
        <div class="row mt-3">
          <div class="col-md-12">
            <h6 class="text-sm">Status</h6>
            <span class="badge bg-gradient-{% if project.status == 'completed' %}success{% elif project.status == 'in_progress' %}info{% elif project.status == 'planned' %}secondary{% else %}warning{% endif %}">
              {{ project.get_status_display }}
            </span>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-6">
            <h6 class="text-sm">Implementation Date</h6>
            <p class="text-sm">{{ project.implementation_date }}</p>
          </div>
          <div class="col-md-6">
            <h6 class="text-sm">Completion Date</h6>
            <p class="text-sm">{{ project.completion_date|default:"Not set" }}</p>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-12">
            <h6 class="text-sm">Targeted Keywords</h6>
            <div class="d-flex flex-wrap gap-2">
              {% for keyword in project.targeted_keywords.all %}
                <span class="badge bg-light text-dark">{{ keyword.keyword }}</span>
              {% empty %}
                <p class="text-sm text-muted">No keywords assigned</p>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <a href="{% url 'seo_manager:edit_project' client.id project.id %}" class="btn bg-gradient-primary btn-sm">Edit Project</a>
        <form method="post" action="{% url 'seo_manager:delete_project' client.id project.id %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn bg-gradient-danger btn-sm" onclick="return confirm('Are you sure you want to delete this project?')">Delete Project</button>
        </form>
        <button type="button" class="btn bg-gradient-secondary btn-sm" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}

{% endblock content %}

{% block extra_js %}
<script>
  document.getElementById('deleteClientBtn').addEventListener('click', function() {
    Swal.fire({
      title: 'Are you sure?',
      text: "You won't be able to revert this!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
      if (result.isConfirmed) {
        // Send delete request to the server
        fetch('{% url "seo_manager:delete_client" client.id %}', {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
          },
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            Swal.fire(
              'Deleted!',
              'The client has been deleted.',
              'success'
            ).then(() => {
              // Redirect to the client list page
              window.location.href = '{% url "seo_manager:client_list" %}';
            });
          } else {
            Swal.fire(
              'Error!',
              'There was an error deleting the client.',
              'error'
            );
          }
        })
        .catch(error => {
          console.error('Error:', error);
          Swal.fire(
            'Error!',
            'There was an error deleting the client.',
            'error'
          );
        });
      }
    });
  });
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var createSnapshotBtn = document.getElementById('createSnapshotBtn');
  if (createSnapshotBtn) {
    createSnapshotBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Show a loading message
      Swal.fire({
        title: 'Creating snapshot...',
        text: 'This may take a few minutes.',
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        willOpen: () => {
          Swal.showLoading();
        }
      });
      
      // Send the request to create the snapshot
      fetch('{% url "seo_manager:create_meta_tags_snapshot" client.id %}', {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
        },
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire({
            title: 'Success!',
            text: data.message,
            icon: 'success',
            confirmButtonText: 'OK'
          }).then((result) => {
            // Refresh the page
            window.location.reload();
          });
        } else {
          Swal.fire({
            title: 'Error!',
            text: data.message,
            icon: 'error',
            confirmButtonText: 'OK'
          });
        }
      })
      .catch(error => {
        console.error('Error:', error);
        Swal.fire({
          title: 'Error!',
          text: 'An error occurred while creating the snapshot.',
          icon: 'error',
          confirmButtonText: 'OK'
        });
      });
    });
  }
});
</script>
{% endblock extra_js %}

